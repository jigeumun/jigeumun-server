<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ê²°ì œ ì™„ë£Œ</title>
</head>
<body>

<h2>ê²°ì œ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</h2>
<div id="result"></div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const paymentKey = urlParams.get("paymentKey");
const orderId = urlParams.get("orderId");
const amount = urlParams.get("amount");

// ğŸ‘‰ ì´ì „ í˜ì´ì§€ì—ì„œ ì €ì¥í•œ ì‚¬ì£¼ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
const birth = localStorage.getItem("birth");
const time = localStorage.getItem("time");
const gender = localStorage.getItem("gender");

if (!paymentKey || !orderId || !amount) {
  document.getElementById("result").innerText = "ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.";
} else {

  // 1ï¸âƒ£ ê²°ì œ ê²€ì¦
  fetch("/verify-payment", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ paymentKey, orderId, amount })
  })
  .then(res => res.json())
  .then(data => {

    if (data.success) {

      document.getElementById("result").innerHTML =
        "<h3>ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ âœ…</h3><p>ì‚¬ì£¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>";

      // 2ï¸âƒ£ ì‚¬ì£¼ ë¶„ì„ í˜¸ì¶œ
      return fetch("/api/saju", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ birth, time, gender })
      });

    } else {
      throw new Error("ê²°ì œ ê²€ì¦ ì‹¤íŒ¨");
    }

  })
  .then(res => res.json())
  .then(data => {

    document.getElementById("result").innerHTML =
      "<h3>ğŸ”® ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼</h3><pre style='white-space: pre-wrap;'>" +
      data.result +
      "</pre>";

  })
  .catch(err => {
    document.getElementById("result").innerText =
      "ì˜¤ë¥˜ ë°œìƒ: " + err.message;
  });
}
</script>

</body>
</html>
