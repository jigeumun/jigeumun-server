require("dotenv").config();
const express = require("express");
const axios = require("axios");
const bodyParser = require("body-parser");

const app = express();
app.use(bodyParser.json());
app.use(express.static("."));

const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const TOSS_SECRET_KEY = process.env.TOSS_SECRET_KEY;

if (!TOSS_SECRET_KEY) {
  console.error("âŒ TOSS_SECRET_KEY í™˜ê²½ë³€ìˆ˜ ì—†ìŒ");
}

//////////////////////////////////////////////////////
// ðŸ”® ê³ ê¸‰ ì‚¬ì£¼ ë¶„ì„ API
//////////////////////////////////////////////////////
app.post("/api/saju", async (req, res) => {
  const { birth, time, gender } = req.body;
  console.log("ë°›ì€ ê°’:", req.body);

  const prompt = `
  ë‹¹ì‹ ì€ 30ë…„ ê²½ë ¥ì˜ ìµœê³ ê¸‰ ëª…ë¦¬í•™ìžìž…ë‹ˆë‹¤.
ì´ ê³ ê°ì€ ì‹¤ì œ ê²°ì œë¥¼ ì™„ë£Œí•œ ìœ ë£Œ ê³ ê°ìž…ë‹ˆë‹¤.
ìƒë‹´ ë³´ê³ ì„œ ìˆ˜ì¤€ìœ¼ë¡œ ìž‘ì„±í•˜ì‹­ì‹œì˜¤.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[ë¶„ì„ ì ˆì°¨ â€“ ë°˜ë“œì‹œ ë‚´ë¶€ì ìœ¼ë¡œ ìˆ˜í–‰]

1) ìƒë…„ì›”ì¼ê³¼ ì¶œìƒì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ì£¼ êµ¬ì¡°ë¥¼ ì¶”ì •í•˜ì‹­ì‹œì˜¤.
2) ì˜¤í–‰ ë¶„í¬ì˜ ê°•ì•½ì„ ë¨¼ì € íŒë‹¨í•˜ì‹­ì‹œì˜¤.
3) ì¼ê°„ ì¤‘ì‹¬ìœ¼ë¡œ ì‹ ê°•/ì‹ ì•½ êµ¬ì¡°ë¥¼ íŒë³„í•˜ì‹­ì‹œì˜¤.
4) ìš©ì‹ ê³¼ ê¸°ì‹  ë°©í–¥ì„ ì„¤ì •í•˜ì‹­ì‹œì˜¤.
5) ê·¸ êµ¬ì¡°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ìƒ íë¦„ì„ í•´ì„í•˜ì‹­ì‹œì˜¤.

â€» ë‹¨ìˆœ ìš´ì„¸ ë¬¸ìž¥ ìƒì„± ê¸ˆì§€.
â€» êµ¬ì¡° â†’ ê·¼ê±° â†’ ê²°ê³¼ ìˆœì„œë¡œ ì „ê°œ.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â— ì ˆëŒ€ ê·œì¹™

- ëª¨ë“  í•­ëª© ìµœì†Œ ê¸°ì¤€ ë¶„ëŸ‰ì„ ë°˜ë“œì‹œ ì§€í‚¬ ê²ƒ
- ì ˆëŒ€ í•­ëª© ìƒëžµ ê¸ˆì§€
- "ê°€ëŠ¥ì„±", "~ì¼ ìˆ˜ ìžˆë‹¤", "ì°¸ê³ ìš©" ê¸ˆì§€
- ë‹¨ì •ì  ì–´ì¡° ìœ ì§€
- ì¶”ìƒ í‘œí˜„ ê¸ˆì§€
- ìµœì†Œ 2200ìž ì´ìƒ
- ì „ë¬¸ê°€ ë³´ê³ ì„œ í†¤ ìœ ì§€
- ì¤„ ê°„ê²© ì¶©ë¶„ížˆ ìœ ì§€

[ìž…ë ¥ ì •ë³´]
- ìƒë…„ì›”ì¼: ${birth}
- ì¶œìƒì‹œê°„: ${time}
- ì„±ë³„: ${gender}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. ðŸ”® ì§€ê¸ˆìš´ ì ìˆ˜ (100ì  ë§Œì )

í˜•ì‹:
ðŸ”® ì§€ê¸ˆìš´ ì ìˆ˜: 00ì 

- ì ìˆ˜ ì‚°ì • ê·¼ê±°ë¥¼ ì˜¤í–‰ ê· í˜•ê³¼ ëŒ€ìš´ íë¦„ ê¸°ì¤€ìœ¼ë¡œ 5ì¤„ ì´ìƒ ì„¤ëª…
- í˜„ìž¬ ìž¬ë¬¼ íë¦„ì˜ ìƒìŠ¹/ì •ì²´/í•˜ë½ êµ¬ì¡° ëª…í™•ížˆ ì„¤ëª…

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

2. ì „ì²´ ì‚¬ì£¼ êµ¬ì¡° í•µì‹¬ ë¶„ì„

- ì¼ê°„ ì¤‘ì‹¬ ì„±í–¥
- ì˜¤í–‰ ë¶ˆê· í˜• ì—¬ë¶€
- í˜„ìž¬ ëŒ€ìš´ ìœ„ì¹˜
- ì¸ìƒ êµ¬ì¡°ì˜ ë°©í–¥ì„±

ìµœì†Œ 6ì¤„ ì´ìƒ.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

3. ì´ˆë…„ìš´ (1~30ì„¸)

ì„±í–¥ í˜•ì„±, í™˜ê²½ ì˜í–¥, ê¸°ìš´ ì¶•ì  ê³¼ì • ì„¤ëª….
ìµœì†Œ 5ì¤„ ì´ìƒ.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

4. ì¤‘ë…„ìš´ (31~50ì„¸)

ìž¬ë¬¼ í™•ìž¥ ê°€ëŠ¥ì„±
ì‚¬íšŒì  ìœ„ì¹˜ ìƒìŠ¹ êµ¬ì¡°
ì¸ê°„ê´€ê³„ ìž¬íŽ¸ íë¦„
ìµœì†Œ 6ì¤„ ì´ìƒ.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

5. ìž¥ë…„ìš´ (51ì„¸ ì´í›„)

ì•ˆì •ì„±, ìžì‚° ì¶•ì  ë°©í–¥
ê±´ê°• íë¦„ í¬í•¨
ìµœì†Œ 5ì¤„ ì´ìƒ.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

6. ìŒì–‘ì˜¤í–‰ ë¶„ì„

- ëª©ì˜ ê¸°ìš´: ê°•/ì¤‘/ì•½ íŒë‹¨ + ê·¼ê±° 3ì¤„ ì´ìƒ
- í™”ì˜ ê¸°ìš´:
- í† ì˜ ê¸°ìš´:
- ê¸ˆì˜ ê¸°ìš´:
- ìˆ˜ì˜ ê¸°ìš´:

ê° ê¸°ìš´ë³„ ë³´ì™„ ì „ëžµ í¬í•¨.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

7. ì‚¬ì£¼ì— ë§žëŠ” ì§ì—… 5ê°€ì§€

ê° í•­ëª© í˜•ì‹ ì—„ìˆ˜:

1) ì§ì—…ëª…
- ì˜¤í–‰ êµ¬ì¡°ì™€ì˜ ì—°ê²°ì„±
- ì„±í–¥ ì í•©ì„±
- ìž¬ë¬¼ íë¦„ ì—°ê²°ì„±
- í˜„ì‹¤ ì ìš© ì „ëžµ

(ê° ì§ì—… ìµœì†Œ 4ì¤„ ì´ìƒ, ì´ 5ê°œ ë°˜ë“œì‹œ ìž‘ì„±)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

8. ì¸ê°„ê´€ê³„ ë° ë°°ìš°ìž êµ¬ì¡°

- ë°°ìš°ìž ìœ í˜•
- ê°ˆë“± ë°œìƒ êµ¬ì¡°
- ê²°í˜¼ ì ê¸° íë¦„

ìµœì†Œ 5ì¤„ ì´ìƒ.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

9. ê¶í•©ì´ ìž˜ ë§žëŠ” ë  3ê°€ì§€

ê° ë ë³„ 3ì¤„ ì´ìƒ ì´ìœ  ì„¤ëª….

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

10. 2026ë…„ ì›”ë³„ ìž¬ë¬¼ íë¦„

1ì›”ë¶€í„° 12ì›”ê¹Œì§€:

- ìž¬ë¬¼ ê¸°íšŒ ì‹œê¸°
- ê³„ì•½/í™•ìž¥ ìœ ë¦¬í•œ ë‹¬
- ì§€ì¶œ/ì†ì‹¤ ì£¼ì˜ ë‹¬
- í–‰ë™ ì „ëžµ

ê° ì›” ìµœì†Œ 2~3ì¤„ ì´ìƒ.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

11. ì§€ê¸ˆ ë°˜ë“œì‹œ í•´ì•¼ í•  í–‰ë™ 3ê°€ì§€

í˜•ì‹:

1) í–‰ë™
- êµ¬ì¡°ì  ì´ìœ 
- ë¯¸ì‹¤í–‰ ì‹œ ì†ì‹¤ êµ¬ì¡°
- ì‹¤í–‰ ì‹œ ê¸°ëŒ€ ê²°ê³¼

(ê° í–‰ë™ ìµœì†Œ 4ì¤„ ì´ìƒ)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ë³´ê³ ì„œ í˜•ì‹ ìœ ì§€.
ì ˆëŒ€ í•­ëª© ìƒëžµ ê¸ˆì§€.
`;

  try {
    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-4o-mini",
        messages: [
          { role: "system", content: "ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ìµœê³  ìˆ˜ì¤€ì˜ ëª…ë¦¬í•™ìžìž…ë‹ˆë‹¤." },
          { role: "user", content: prompt }
        ],
        temperature: 0.6,
        max_tokens: 3000
      },
      {
        headers: {
          Authorization: `Bearer ${OPENAI_API_KEY}`,
          "Content-Type": "application/json",
        },
      }
    );

    res.json({ result: response.data.choices[0].message.content });

  } catch (error) {
    console.error("ðŸ”¥ OpenAI ì—ëŸ¬:", error.response?.data || error.message);
    res.status(500).json({ error: "ì‚¬ì£¼ ë¶„ì„ ì‹¤íŒ¨" });
  }
});

//////////////////////////////////////////////////////
// ðŸ’³ í† ìŠ¤ ê²°ì œ ê²€ì¦ API
//////////////////////////////////////////////////////
app.post("/verify-payment", async (req, res) => {
  const { paymentKey, orderId, amount } = req.body;

  try {
    const amountNumber = Number(amount);

    const response = await axios.post(
      "https://api.tosspayments.com/v1/payments/confirm",
      {
        paymentKey,
        orderId,
        amount: amountNumber
      },
      {
        headers: {
          Authorization:
            "Basic " +
            Buffer.from(process.env.TOSS_SECRET_KEY + ":").toString("base64"),
          "Content-Type": "application/json",
        },
      }
    );

    console.log("âœ… ê²°ì œ ê²€ì¦ ì„±ê³µ");
    res.json({ success: true });

  } catch (error) {
    console.error("ðŸ”¥ í† ìŠ¤ ì—ëŸ¬:", error.response?.data || error.message);
    res.status(400).json({
      success: false,
      message: error.response?.data || "ê²°ì œ ê²€ì¦ ì‹¤íŒ¨"
    });
  }
});

//////////////////////////////////////////////////////

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log("ðŸš€ Server running on port " + PORT);
});
